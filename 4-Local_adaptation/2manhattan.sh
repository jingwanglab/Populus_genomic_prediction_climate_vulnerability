#!/bin/bash
set -e
sh_file="manhattan.sh"
indir="/w/00/g/g00/sangyupeng/xiangyang/LEA3/input_file/chongzuo/chongzuo-onebio-summary/manhattan"
R_dir="/w/00/u/user201/manhattan.R"
OUTDIR="/w/00/g/g00/sangyupeng/xiangyang/LEA3/input_file/chongzuo/chongzuo-onebio-summary/manhattan/R"
count_file="/w/00/g/g00/sangyupeng/xiangyang/LEA3/input_file/chongzuo/chongzuo-onebio-summary/manhattan/R/19bios_count.txt"
echo "bio ount0.1 count0.05 count0.01" > $count_file
#### create R scripts
for file in $indir/*.txt
do
	temp=${file##*_}
	bio=${temp%.*}
	outdir="$OUTDIR/$bio"
	if [ ! -d $outdir ];then
	mkdir $outdir
	fi	
	outfile="$bio.sort.txt"
	OUTFILE=$OUTDIR"/"$outfile
	Rscript="$bio.R"
	pdf="$bio.pdf"
	echo "#! /data/apps/R/4.0.3/bin/Rscript --no-save --no-restore
.libPaths(\"/w/00/u/user201/R/x86_64-pc-linux-gnu-library/4.0\")
library(ggplot2)
library(plyr)
library(data.table)
library(RColorBrewer)
library(qqman)
library(qvalue)
setwd(\"$outdir\")
summary=read.table(\"$file\",head=T,stringsAsFactors=F)

###pvalue and qvalue for the output file of GEMMEA that do not include the neutral population structure in it

q=qvalue(summary\$P)
q_value=qvalue(summary\$P,fdr.level=0.05)
summary\$qvalues=q_value\$qvalues
o <- order(summary[,\"qvalues\"])

count1=sum(unlist(summary\$qvalues)<=0.1)
count2=sum(unlist(summary\$qvalues)<=0.05)
count3=sum(unlist(summary\$qvalues)<=0.01)
bios=\"$bio\"
count<-c(bios,count1,count2,count3)
cat(\"\n\",count[1],count[2],count[3],count[4],file=\"$count_file\",append =T,row.names = F, col.names = F,quote=F)
write.table(o,file=\"$OUTFILE\")
png(\"$png\",width=15,height=4,units='in',res=500)
par(mar=c(5,5,2,2))
manhattan(summary,main=\"$bio\",suggestiveline =T,genomewideline =T,col=c(\"#1D4989\",\"#6692C8\"),annotatePval=0.01,cex.axis = 1.2,cex.lab=1.4)
dev.off()" > $R_dir/$Rscript
done
for file in $R_dir/*
do
	echo "source ~/.bashrc;Rscript $file" >> $sh_file
done








