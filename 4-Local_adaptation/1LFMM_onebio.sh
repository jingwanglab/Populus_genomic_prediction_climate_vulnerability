#!/bin/bash
set -e
indir="/w/00/g/g00/sangyupeng/xiangyang/LEA3/input_file/pk230_phase_maf0.1_chr"
OUTDIR="/w/00/g/g00/sangyupeng/xiangyang/LEA3/input_file/chongzuo/LFMM"
envdir="/w/00/g/g00/sangyupeng/xiangyang/LEA3/input_file/chongzuo/env"
pop="/w/00/g/g00/sangyupeng/xiangyang/LEA3/pop.txt"
sh_file="/w/00/u/user201/LFMM_onebio_new.sh"
script_dir="/w/00/u/user201/LFMM_onebio_19.R"
#create Rscript_dir
if [ ! -d $script_dir ];then
mkdir $script_dir
###!!!! be careful !!!
else 
	cd $script_dir;rm -rf * 
fi
#create outdir
for env_file in $envdir/*.env
do
	env=${env_file##*/}
	bio=${env%.*}
	if [ ! -d $OUTDIR/$bio ];then
	mkdir $OUTDIR/$bio
	fi 
	for dir in $indir/*
	do	
		chr=${dir##*/}
		outdir="$bio_phase_$chr"
		if [ ! -d $OUTDIR/$bio/$outdir ];then
		mkdir $OUTDIR/$bio/$outdir
		fi
		cp $env_file $OUTDIR/$bio/$outdir
		Rscript=${dir##*/}$bio.R
		lfmm=${dir##*/}.pk230_phase_maf01_$bio.lfmm
		file1=${dir##*/}_phase_pvalues_run1.csv
		file2=${dir##*/}_phase_pvalues_run2.csv
		file3=${dir##*/}_phase_pvalues_run3.csv
		file4=${dir##*/}_phase_pvalues_run4.csv
		file5=${dir##*/}_phase_pvalues_run5.csv
		inputfile="pk230.$chr.phase.maf0.1.ped"
		echo "#! /data/apps/R/4.0.3/bin/Rscript --no-save --no-restore
.libPaths(\"/w/00/u/user201/R/x86_64-pc-linux-gnu-library/4.0\")
library(LEA)
setwd(\"$OUTDIR/$bio/$outdir\")
lfmm <- ped2lfmm(\"$dir/$inputfile\", output.file = \"$lfmm\",force = T)
project <- lfmm(\"$lfmm\",\"$env\",CPU=6,K = 3,repetitions = 5, project = \"new\")
p = lfmm.pvalues(project, K = 3,  d = 1, run = 1)
pvalues = p\$pvalues
write.csv(pvalues,\"$file1\")
p = lfmm.pvalues(project, K = 3,  d = 1, run = 2)
pvalues = p\$pvalues
write.csv(pvalues,\"$file2\")
p = lfmm.pvalues(project, K = 3,  d = 1, run = 3)
pvalues = p\$pvalues
write.csv(pvalues,\"$file3\")
p = lfmm.pvalues(project, K = 3,  d = 1, run = 4)
pvalues = p\$pvalues
write.csv(pvalues,\"$file4\")
p = lfmm.pvalues(project, K = 3,  d = 1, run = 5)
pvalues = p\$pvalues
write.csv(pvalues,\"$file5\")" >> $script_dir/$Rscript
	done
done
for file in $script_dir/*
do
	echo "source ~/.bashrc;Rscript $file" >> $sh_file
done

#### then merge 5-runs results, and calculate the average Pvalue of every site and turn in to q-value in R.

