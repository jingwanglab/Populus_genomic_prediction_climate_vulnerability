.libPaths("F:/360MoveData/Users/dell/Documents/R")
rm(list=ls())
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
library(corrplot)
setwd("F:/360MoveData/Users/Desktop/NC/future/RONA/RONA_ave")
RONA_weighted_dir="F:/360MoveData/Users/Desktop/NC/future/RONA/RONA_ave/RONA_weighted"
RONA_SE_dir="F:/360MoveData/Users/Desktop/NC/future/RONA/RONA_ave/RONA_SE"
outdir="F:/360MoveData/Users/Desktop/NC/future/RONA/RONA_4models_corplot"
PK=read.csv("pk.csv",head=T)
model_list=c("BJ","wc2.1_2.5m_bioc_ACCESS-CM2","wc2.1_2.5m_bioc_CanESM5","wc2.1_2.5m_bioc_GISS-E2-1-G")
SSP_list=c("ssp126","ssp245","ssp370","ssp585")

cor.mtest <- function(mat) {
  mat <- as.matrix(mat)
  n <- ncol(mat)
  p.mat<- matrix(NA, n, n)
  diag(p.mat) <- 0
  for (i in 1:(n - 1)) {
    for (j in (i + 1):n) {
      tmp <- cor.test(mat[, i], mat[, j], method = "spearman",exact=FALSE)
      p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
    }
  }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

data_pk=list()
for (i in 1:19){
  ###create list to load data of 19 BIOs
  data_pk[[i]]=PK
  for (model in model_list){
    SSP_data=list()
    for (data_type in c("RONA_weighted","RONA_SE")){
      for (j in 1:4){
        data2080=read.csv(paste(data_type,"/",model,"/",model,"_",SSP_list[j],"_2061-2080NC_",data_type,".csv",sep=""),head=T) 
        data2100=read.csv(paste(data_type,"/",model,"/",model,"_",SSP_list[j],"_2081-2100NC_",data_type,".csv",sep=""),head=T)
        BIO_2080=data2080[i+1]
        BIO_2100=data2100[i+1]
        col_name=paste(model,data_type,sep="_")
        colnames(BIO_2080)=colnames(BIO_2100)=col_name
        SSP_data[[j]]=rbind(BIO_2080,BIO_2100)
      }
      data_pk[[i]][col_name]=rbind(SSP_data[[1]],SSP_data[[2]],SSP_data[[3]],SSP_data[[4]])
    }
  }
}
### calculate average RONA of 4 models
for (i in 1:19){
  data_pk[[i]]$ave_RONA=apply(data_pk[[i]][,c(5,7,9,11)],1,mean)
  data_pk[[i]]$ave_SE=apply(data_pk[[i]][,c(6,8,10,12)],1,mean)
  colnames(data_pk[[i]])=c("POP","POP_order","year","SSP","BCC","BJ_SE","ACCESS","ACC_SE","CanESM5","Can_SE","GISS","GIS_SE","Ave_RONA","Ave_SE")
}

year_list=c("2061-2080","2081-2100")
ssp_list=c("ssp_126","ssp_245","ssp_370","ssp_585")
#### BIO5 
rawdata=data_pk[[5]]
rawtdata=rawdata[,c(3,4,5,7,9,11)]

#pdf(paste(outdir,"/BIO5/",YEAR,"_",ssp,".pdf",sep=""),width=7,height=5)
pdf("F:/360MoveData/Users/Desktop/NC/future/RONA/RONA_4models_corplot/BIO5.pdf",width=5,height=8)
opar<-par(no.readonly=TRUE)
par(mfrow=c(4,2))
for (ssp in ssp_list){
  for (YEAR in year_list){
    plotdata=subset(rawtdata,SSP==ssp & year==YEAR) 
    plotdata_p =  cor.mtest (plotdata[,-c(1:2)])
    plotdata_r = cor(plotdata[,-c(1:2)], method = "spearman")
    col3 <- colorRampPalette(c('#1B5196','white','#1B5196','white',"#CC2526")) 
    corrplot.mixed(plotdata_r,lower="number",upper="ellipse",upper.col =col3(20),diag="u",
                   lower.col = col3(20),number.cex=1.1,tl.cex = 1.2,
                   tl.pos='n',family="sans",
                   is.corr=T,col.lim=c(0,1), mar=c(0, 0, 0, 0))
    corrplot(plotdata_p,col =col3(20),p.mat=plotdata_p,
             type='upper',sig.level = c(0.001,0.01,0.05),insig ="label_sig",pch.cex = 1.2,
             pch.col="black",diag = T, bg =NULL,rect.lwd = 1, tl.cex = 1.2,
             tl.col = "black", tl.offset = 0.4, tl.srt = 90,cl.pos='n',
             cl.cex = 0.6, cl.ratio = 0.2,tl.pos="lt",family="sans",
             cl.offset = 0.4,is.corr=T,col.lim=c(0,1),add=T, mar=c(0, 0, 0, 0))
  }
}
par(opar)
dev.off()

#### BIO13
rawdata=data_pk[[13]]
rawtdata=rawdata[,c(3,4,5,7,9,11)]

pdf("F:/360MoveData/Users/Desktop/NC/future/RONA/RONA_4models_corplot/BIO13.pdf",width=5,height=8)
opar<-par(no.readonly=TRUE)
par(mfrow=c(4,2))
for (ssp in ssp_list){
  for (YEAR in year_list){
    plotdata=subset(rawtdata,SSP==ssp & year==YEAR) 
    plotdata_p =  cor.mtest (plotdata[,-c(1:2)])
    plotdata_r = cor(plotdata[,-c(1:2)], method = "spearman")
    col3 <- colorRampPalette(c('#1B5196','white','#1B5196','white',"#CC2526")) 
    corrplot.mixed(plotdata_r,lower="number",upper="ellipse",upper.col =col3(20),diag="u",
                   lower.col = col3(20),number.cex=1.1,tl.cex = 1.2,
                   tl.pos='n',family="sans",
                   is.corr=T,col.lim=c(0,1), mar=c(0, 0, 0, 0))
    corrplot(plotdata_p,col =col3(20),p.mat=plotdata_p,
             type='upper',sig.level = c(0.001,0.01,0.05),insig ="label_sig",pch.cex = 1.2,
             pch.col="black",diag = T, bg =NULL,rect.lwd = 1, tl.cex = 1.2,
             tl.col = "black", tl.offset = 0.4, tl.srt = 90,cl.pos='n',
             cl.cex = 0.6, cl.ratio = 0.2,tl.pos="lt",family="sans",
             cl.offset = 0.4,is.corr=T,col.lim=c(0,1),add=T, mar=c(0, 0, 0, 0))
  }
}
par(opar)
dev.off()






