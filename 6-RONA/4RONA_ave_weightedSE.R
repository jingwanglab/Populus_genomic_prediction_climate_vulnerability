#! /usr_storage/syp/.conda/envs/R/bin/Rscript --no-save --no-restore
.libPaths("/usr_storage/syp/.conda/envs/R/lib/R/library")
library(data.table)
library(plotrix)
REF_freq=read.table("/usr_storage/syp/pk_paper/new_RONA/1799_REF_freq.txt",head=T,row.names=1)
input_unLD_dir="/usr_storage/syp/pk_paper/new_RONA/step1_adaption-loci/unLD/"
now_env=read.csv("/usr_storage/syp/NC/RONA/NOW24.csv",head=T,row.names=1)
pop=read.csv("/usr_storage/syp/NC/RONA/NOW24.csv",head=T)
pop=pop[1]
future_env_dir="/usr_storage/syp/NC/future_data/future_point_24"
outdir_SE="/usr_storage/syp/NC/RONA/SE/ave"
now_env=now_env[,-c(1:2)]
setwd("/usr_storage/syp/NC/RONA")

#### RONA R function ####
rona_pred <- function(gen, present, future, significance, weighted){
  rona_output <- matrix(NA, nrow=nrow(gen), ncol=ncol(gen)) # empty matrix to save risk values
  allfreq_output <- matrix(NA, nrow=nrow(gen), ncol=ncol(gen)) # empty matrix to save future allele frequencies predicted
  reg_output <- matrix(NA, nrow=ncol(gen), ncol=5) # empty matrix to save regression parameters
  colnames(rona_output) <- colnames(gen) # track the locus id in the output
  for (j in 1:ncol(gen)) { # loop for each locus
    for (i in 1:nrow(gen)) { # loop for each population
      reg <- lm(gen[,j] ~  unlist(present)) # compute the linear regression
      rona_output[i,j] <- abs((coef(reg)[2] * future[i,] + coef(reg)[1]) - gen[i,j]) # calculate the risk of non-adaptedness
      allfreq_output[i,j] <- coef(reg)[2] * future[i,] + coef(reg)[1]
      reg_output[j,1] <- summary(reg)$fstatistic[1] # save parameters of the linear regression for each locus
      reg_output[j,2] <- summary(reg)$coefficients[2,4]
      reg_output[j,3] <- summary(reg)$r.squared
      reg_output[j,4] <- summary(reg)$adj.r.squared
      reg_output[j,5] <- summary(reg)$sigma
    }
  }
  SEM=matrix(NA, nrow=nrow(gen), ncol=1)
  for (i in 1:nrow(SEM)) {
		SEM[i,]=std.error(rona_output[i,],na.rm)
	}
  rona_output <- as.data.frame(rona_output, row.names=rownames(gen)) # convert matrix to dataframe for downstream data maniputation and calculation
  colnames(allfreq_output) <- colnames(gen)
  rownames(allfreq_output) <- rownames(gen)
  colnames(reg_output) <- c("statistic", "pvalue", "Rsquared", "adjRsquared", "sigma") # rename output columns
  row.names(reg_output) <- colnames(gen) # rename output rows
  reg_output <- as.data.frame(reg_output) # convert matrix to dataframe for downstream data maniputation and calculation
  
  if (significance == "TRUE") {
    reg_output <- subset(reg_output, subset=reg_output$pvalue < 0.05) # significance set at 0.05
    rona_output <- rona_output[, row.names(reg_output)]
    allfreq_output <- allfreq_output[, row.names(reg_output)]
  } 
  
  avg_rona_output <- as.data.frame(rowMeans(rona_output, na.rm=TRUE)) # calculate the averaged unweighted RONA across the loci
  colnames(avg_rona_output) <- c("Avg_unweighted_RONA")
  
  if (weighted == "TRUE") {
    tmp <- matrix(NA, nrow=nrow(gen), ncol=1) # create a temporary matrix
    for (i in 1:nrow(gen)) {
      tmp[i] <- weighted.mean(rona_output[i,], reg_output[,"Rsquared"], na.rm=TRUE) # weighting the loci per R squared
    }
    avg_rona_output[,1] <- tmp
    colnames(avg_rona_output) <- c("Avg_weighted_RONA")
  }
  
  colnames(rona_output) <- paste("rona", colnames(rona_output), sep="_") # rename loci to avoid any confusion with input data
  colnames(allfreq_output) <- paste("pred", colnames(allfreq_output), sep="_")
  
  final_output <- list(reg_output, rona_output, avg_rona_output, allfreq_output,SEM) # create a list object for the final output
  return(final_output)
}

future_model=c("BJ","wc2.1_2.5m_bioc_ACCESS-CM2","wc2.1_2.5m_bioc_CanESM5","wc2.1_2.5m_bioc_GISS-E2-1-G")
year_ssp_list=c("SSP126_2061-2080","SSP245_2061-2080","SSP370_2061-2080","SSP585_2061-2080","SSP126_2081-2100","SSP245_2081-2100","SSP370_2081-2100","SSP585_2081-2100" )

for (year_ssp in year_ssp_list){
	SE_ave=pop
	for  (j in 1:19){
		BIO=paste("BIO",j,sep="")
		SE_model=list()
			for (model in future_model){
				future_env_file=paste(future_env_dir,"/",model,"/",model,"-",year_ssp,"_24.csv",sep="")
				result_raw_RONA=as.data.frame(matrix(nrow=24))
				result_raw_RONA$POP=rownames(now_env)
				future_env=read.table(future_env_file,head=T,row.names=1)
				unLD_ID=read.table(paste(input_unLD_dir,"1779ID_BIO",j,".txt",sep=""),head=F,row.names=1)
				temp_BIO=REF_freq[,colnames(REF_freq)%in%rownames(unLD_ID)]
				temp_unLD=rona_pred(temp_BIO,now_env[j],future_env[j],"FALSE","TRUE")
				weight_rona=data.frame(matrix(unlist(temp_unLD[3]), nrow=24, byrow=T),stringsAsFactors=FALSE)
				SE_model[[model]]=data.frame(matrix(unlist(temp_unLD[2]), nrow=24, byrow=T),stringsAsFactors=FALSE)
			}
		SE_all=cbind(SE_model[[1]],SE_model[[2]],SE_model[[3]],SE_model[[4]])
		temp=matrix(NA, nrow=24)
		for (i in 1:nrow(SE_all)) {
			temp[i,]=std.error(as.numeric(SE_all[i,]),na.rm)
		}
		SE_ave[BIO]=temp[,1]
	}
	write.csv(SE_ave,file=paste(outdir_SE,"/ave_",year_ssp,"NC_RONA_SE.csv",sep=""),quote=F,row.names=F)
}



