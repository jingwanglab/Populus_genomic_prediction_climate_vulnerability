#!/bin/bash
set -e
sites_dir="/w/00/g/g00/sangyupeng/xiangyang/reference/true_bed/sites"
fa_dir="/w/00/g/g00/sangyupeng/xiangyang/reference/true_bed"
apply_mask_l="/w/00/u/user201/software/seqbility-20091110/apply_mask_l"
mask_sites_dir="/w/00/g/g00/sangyupeng/xiangyang/reference/true_bed/mask_sites"
mask_mappability_dir="/w/00/g/g00/sangyupeng/xiangyang/reference/true_bed/mask_mappability"
bed_dir="/w/00/g/g00/sangyupeng/xiangyang/reference/bed"
final_bed_dir="/w/00/g/g00/sangyupeng/xiangyang/reference/true_bed/final_bed"

for sites_file in $sites_dir/*.sites.txt
do
	temp=${sites_file##*/}
	temp2=${temp%.sites*}
	chr=${temp2#*.}
	fa_file=${temp%.sites*}.Mask_100_0.5.fa
	bed_file=${temp%.sites*}.bed
	mask_sites_file=${temp%.sites*}.mask.txt
	mask_mappability_file=${temp%.sites*}.mask_mappability.txt
	final_bed_file=${temp%.sites*}.mask_mappability.bed
	if [ $temp2 == zsp193a-LH.contig ]; then
	$apply_mask_l $fa_dir/$fa_file $sites_file > $mask_sites_dir/$mask_sites_file
	contig_n=`cat $bed_dir/$bed_file | wc -l`
	for ((i=1;i<=$contig_n;i++))
	do
		contig=$(head -n $i $bed_dir/$bed_file |tail -n 1 |cut -f 1)
		echo "awk '\$1==\"'$contig'\"' $mask_sites_dir/$mask_sites_file | awk 'NR==1{chr=\$1;start=\$2;end=\$2;next} \$2 == end+1 {end=\$2;next} {print chr,start,end;start=\$2;end=start} END{print chr,start,end}' >> $mask_mappability_dir/$mask_mappability_file;awk 'BEGIN{OFS = \"\t\"}{\$2=\$2-1;print}' $mask_mappability_dir/$mask_mappability_file >> $final_bed_dir/$final_bed_file" >> 17bed_4.sh
	done
	else
	echo "$apply_mask_l $fa_dir/$fa_file $sites_file > $mask_sites_dir/$mask_sites_file;awk '\$1==\"'$chr'\"' $mask_sites_dir/$mask_sites_file | awk 'NR==1{chr=\$1;start=\$2;end=\$2;next} \$2 == end+1 {end=\$2;next} {print chr,start,end;start=\$2;end=start} END{print chr,start,end}' >> $mask_mappability_dir/$mask_mappability_file;awk 'BEGIN{OFS = \"\t\"}{\$2=\$2-1;print}' $mask_mappability_dir/$mask_mappability_file > $final_bed_dir/$final_bed_file" >> 17bed_4.sh
	fi
done
