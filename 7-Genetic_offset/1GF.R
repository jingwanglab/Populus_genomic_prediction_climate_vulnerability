#! /usr_storage/syp/.conda/envs/R/bin/Rscript --no-save --no-restore
.libPaths("/usr_storage/syp/.conda/envs/R/lib/R/library")
library(gradientForest)
library(data.table)
setwd("/usr_storage/syp/data3/GF")
env=read.table("/usr_storage/syp/gf/syp-gf/cand3055/environ_gf.txt", header=T)
envGF=env[, c("bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
pops=read.table("/usr_storage/syp/gf/syp-gf/cand3055/GF_lon_lat.txt", header=T)
sites=pops[, c("lon", "lat")]
Grid=fread("/usr_storage/syp/gf/syp-gf/cand3055/qrug_bcg_present.txt",header=T)
grid=Grid[, c("lon", "lat")]
greengrid=Grid[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
all_SNPs=read.table("data3cand05_MAF.txt",head=T)
preds <- colnames(envGF)
specs <- colnames(all_SNPs)
nSites <- dim(envGF)[1]

nSpecs <- dim(all_SNPs)[2]
maxLevel <- log2(0.368*nrow(envGF)/2)
all_gfmod <- gradientForest(cbind(envGF, all_SNPs), predictor.vars=colnames(envGF),           response.vars=colnames(all_SNPs), ntree=500, compact=T, nbin =1001,maxLevel=maxLevel, trace=T, corr.threshold=0.5)
pdf(file="picture/all_predictoroverallimportance3436.pdf")
plot.gradientForest(all_gfmod,plot.type="O")
dev.off()

write.table(all_gfmod$Y, file="result/all_gf_Y.txt")
write.table(all_gfmod$X, file="result/all_gf_X.txt")
write.table(all_gfmod$imp.rsq, file="result/all_gf_impRsq.txt")
write.table(all_gfmod$result, file="result/all_gf_result.txt")
write.table(all_gfmod$res.u, file="result/all_gf_res_u.txt")
write.table(all_gfmod$res, file="result/all_gf_res.txt")

#splits density plots 
pdf(file="picture/all_splitsdensityplots.pdf")
plot(all_gfmod, plot.type="S", imp.vars=c("bio12","bio15","bio18","bio16","bio17","bio19","bio8","bio10","bio1","bio13","bio4","bio11","bio9","bio14","bio7","bio6","bio2","bio5","bio3"), leg.posn="topright", cex.legend=0.4, cex.axis=0.6, cex.lab=0.7, line.ylab=0.9, par.args=list(mgp=c(1.5, 0.5, 0), mar=c(3.1,1.5,0.1,1)))
dev.off()

#speciescumulativeplot #the legend identifies the top 5 most responsive SNPs for each predictor ??? 
pdf(file="picture/all_speciescumulativeplot.pdf")
plot.gradientForest(all_gfmod, plot.type="Cumulative.Importance", imp.vars=c("bio12","bio15","bio18","bio16","bio17","bio19","bio8","bio10","bio1","bio13","bio4","bio11","bio9","bio14","bio7","bio6","bio2","bio5","bio3"), show.overall=T, legend=T,common.scale=T,leg.posn="topleft", leg.nspecies=5, cex.lab=0.7, cex.legend=0.4, cex.axis=0.6, line.ylab=0.9, par.args=list(mgp=c(1.5, 0.5, 0), mar=c(3.1,1.5,0.1,1),omi=c(0,0.3,0,0)))
dev.off()

#predictorcumulative #show cumulative change in overall composition of the community, where changes occur on the gradient
pdf(file="picture/all_predictorcumulative.pdf")
plot(all_gfmod, plot.type="C", imp.vars=c("bio12","bio15","bio18","bio16","bio17","bio19","bio8","bio10","bio1","bio13","bio4","bio11","bio9","bio14","bio7","bio6","bio2","bio5","bio3"), show.species=F, common.scale=T, cex.axis=0.6, cex.lab=0.7, line.ylab=0.9, par.args=list(mgp=c(1.5, 0.5, 0), mar=c(2.5,1.0,0.1,0.5), omi=c(0,0.3,0,0)))
dev.off()

#R2
pdf(file="picture/all_R2.pdf")
plot(all_gfmod, plot.type="P", show.names=F, horizontal=F, cex.axis=1, cex.labels=0.7, line=2.5)
dev.off()

### PC-plot

all_tgrid=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,greengrid[,c("bio15","bio12","bio19","bio17","bio16","bio18","bio13","bio8","bio10","bio1","bio14","bio11","bio4","bio9","bio7","bio6","bio3","bio2","bio5")]))
n<-sum(is.na(all_tgrid))
n
Trns_grid <- na.omit(all_tgrid)
n<-sum(is.na(Trns_grid))
all_PCs <- prcomp(Trns_grid[,c("bio15","bio19","bio13","bio1","bio3","bio5")],center=TRUE, scale.=FALSE)
summary(all_PCs)
# set up a colour palette for the mapping
a1 <- all_PCs$x[,1]
a2 <- all_PCs$x[,2]
a3 <- all_PCs$x[,3]
r <- a1+a2
g <- -a2
b <- a3+a2-a1
r <- (r-min(r)) / (max(r)-min(r)) * 255
g <- (g-min(g)) / (max(g)-min(g)) * 255
b <- (b-min(b)) / (max(b)-min(b)) * 255

grid$R=r
grid$G=g
grid$B=b

nvs <- dim(all_PCs$rotation)[1] # number of variables
vec <- c("bio15","bio19","bio13","bio1","bio3","bio5")
lv <- length(vec)
vind <- rownames(all_PCs$rotation) %in% vec
scal <- 60
xrng <- range(all_PCs$x[,1], all_PCs$rotation[,1]/scal)*1.1
yrng <- range(all_PCs$x[,2], all_PCs$rotation[,2]/scal)*1.1
pdf(file="picture/all_PCplot.pdf")
plot((all_PCs$x[,1:2]), xlim=xrng, ylim=yrng, pch=".", cex=7, col=rgb(r,g,b, max = 255), asp=1)
arrows(rep(0,lv), rep(0,lv), all_PCs$rotation[,1]/scal, all_PCs$rotation[,2]/scal, length = 0.1)
jit <- 0.0015
text(all_PCs$rotation[,1]/scal+jit*sign(all_PCs$rotation[,1]), all_PCs$rotation[,2]/scal+jit*sign(all_PCs$rotation[,2]), labels = vec)
dev.off()
pdf("picture/Map.pdf")
green.pred <- predict(all_gfmod, greengrid[,c("bio15","bio19","bio13","bio1","bio3","bio5")])
plot(Trns_grid[, c("lon", "lat")], pch=15,cex=1.0,asp=1,col=rgb(r,g,b, max=255),main="SNP turnover in Q rugosa")
dev.off()
#export map for use in ArcGIS
greencols=rgb(r,g,b,max=255)
greencols2=col2rgb(greencols)
greencols3=t(greencols2)
gradients=cbind(Trns_grid[,1:2],greencols3)
gradients$color=greencols
write.csv(gradients,file="result/all_gradients4arcgis.csv",row.names=F,quote=F)
all_tgrid=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,greengrid[,c("bio15","bio12","bio19","bio17","bio16","bio18","bio13","bio8","bio10","bio1","bio14","bio11","bio4","bio9","bio7","bio6","bio3","bio2","bio5")]))

##### genetic_offset

all_tgrid=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,greengrid[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
#2080-26
fut_cli=fread("/usr_storage/syp/gf/syp-gf/cand3055/future/future60000/2080/future-2080-26.txt", header=T)
fut=fut_cli[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
future_all=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,fut[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
genOffsetAll<-sqrt((future_all[,3]-all_tgrid[,3])^2+(future_all[,4]-all_tgrid[,4])^2+(future_all[,5]-all_tgrid[,5])^2+(future_all[,6]-all_tgrid[,6])^2+(future_all[,7]-all_tgrid[,7])^2+(future_all[,8]-all_tgrid[,8])^2+(future_all[,9]-all_tgrid[,9])^2+(future_all[,10]-all_tgrid[,10])^2+(future_all[,11]-all_tgrid[,11])^2+(future_all[,12]-all_tgrid[,12])^2+(future_all[,13]-all_tgrid[,13])^2+(future_all[,14]-all_tgrid[,14])^2+(future_all[,15]-all_tgrid[,15])^2+(future_all[,16]-all_tgrid[,16])^2+(future_all[,17]-all_tgrid[,17])^2+(future_all[,18]-all_tgrid[,18])^2+(future_all[,19]-all_tgrid[,19])^2+(future_all[,20]-all_tgrid[,20])^2+(future_all[,21]-all_tgrid[,21])^2)
Offset=cbind(future_all[,c("lon","lat")],genOffsetAll)
colnames(Offset)[3]<-"offset"
write.csv(Offset, "offset/data3_3436_2080_26.csv", quote=F, row.names=T)
#2080-45
fut_cli=fread("/usr_storage/syp/gf/syp-gf/cand3055/future/future60000/2080/future-2080-45.txt", header=T)
fut=fut_cli[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
future_all=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,fut[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
genOffsetAll<-sqrt((future_all[,3]-all_tgrid[,3])^2+(future_all[,4]-all_tgrid[,4])^2+(future_all[,5]-all_tgrid[,5])^2+(future_all[,6]-all_tgrid[,6])^2+(future_all[,7]-all_tgrid[,7])^2+(future_all[,8]-all_tgrid[,8])^2+(future_all[,9]-all_tgrid[,9])^2+(future_all[,10]-all_tgrid[,10])^2+(future_all[,11]-all_tgrid[,11])^2+(future_all[,12]-all_tgrid[,12])^2+(future_all[,13]-all_tgrid[,13])^2+(future_all[,14]-all_tgrid[,14])^2+(future_all[,15]-all_tgrid[,15])^2+(future_all[,16]-all_tgrid[,16])^2+(future_all[,17]-all_tgrid[,17])^2+(future_all[,18]-all_tgrid[,18])^2+(future_all[,19]-all_tgrid[,19])^2+(future_all[,20]-all_tgrid[,20])^2+(future_all[,21]-all_tgrid[,21])^2)
Offset=cbind(future_all[,c("lon","lat")],genOffsetAll)
colnames(Offset)[3]<-"offset"
write.csv(Offset, "offset/data3_3436_2080_45.csv", quote=F, row.names=T)
#2080-70
fut_cli=fread("/usr_storage/syp/gf/syp-gf/cand3055/future/future60000/2080/future-2080-70.txt", header=T)
fut=fut_cli[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
future_all=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,fut[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
genOffsetAll<-sqrt((future_all[,3]-all_tgrid[,3])^2+(future_all[,4]-all_tgrid[,4])^2+(future_all[,5]-all_tgrid[,5])^2+(future_all[,6]-all_tgrid[,6])^2+(future_all[,7]-all_tgrid[,7])^2+(future_all[,8]-all_tgrid[,8])^2+(future_all[,9]-all_tgrid[,9])^2+(future_all[,10]-all_tgrid[,10])^2+(future_all[,11]-all_tgrid[,11])^2+(future_all[,12]-all_tgrid[,12])^2+(future_all[,13]-all_tgrid[,13])^2+(future_all[,14]-all_tgrid[,14])^2+(future_all[,15]-all_tgrid[,15])^2+(future_all[,16]-all_tgrid[,16])^2+(future_all[,17]-all_tgrid[,17])^2+(future_all[,18]-all_tgrid[,18])^2+(future_all[,19]-all_tgrid[,19])^2+(future_all[,20]-all_tgrid[,20])^2+(future_all[,21]-all_tgrid[,21])^2)
Offset=cbind(future_all[,c("lon","lat")],genOffsetAll)
colnames(Offset)[3]<-"offset"
write.csv(Offset, "offset/data3_3436_2080_70.csv", quote=F, row.names=T)
#2080-85
fut_cli=fread("/usr_storage/syp/gf/syp-gf/cand3055/future/future60000/2080/future-2080-85.txt", header=T)
fut=fut_cli[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
future_all=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,fut[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
genOffsetAll<-sqrt((future_all[,3]-all_tgrid[,3])^2+(future_all[,4]-all_tgrid[,4])^2+(future_all[,5]-all_tgrid[,5])^2+(future_all[,6]-all_tgrid[,6])^2+(future_all[,7]-all_tgrid[,7])^2+(future_all[,8]-all_tgrid[,8])^2+(future_all[,9]-all_tgrid[,9])^2+(future_all[,10]-all_tgrid[,10])^2+(future_all[,11]-all_tgrid[,11])^2+(future_all[,12]-all_tgrid[,12])^2+(future_all[,13]-all_tgrid[,13])^2+(future_all[,14]-all_tgrid[,14])^2+(future_all[,15]-all_tgrid[,15])^2+(future_all[,16]-all_tgrid[,16])^2+(future_all[,17]-all_tgrid[,17])^2+(future_all[,18]-all_tgrid[,18])^2+(future_all[,19]-all_tgrid[,19])^2+(future_all[,20]-all_tgrid[,20])^2+(future_all[,21]-all_tgrid[,21])^2)
Offset=cbind(future_all[,c("lon","lat")],genOffsetAll)
colnames(Offset)[3]<-"offset"
write.csv(Offset, "offset/data3_3436_2080_85.csv", quote=F, row.names=T)
#2100-26
fut_cli=fread("/usr_storage/syp/gf/syp-gf/cand3055/future/future60000/2100/future-2100-26.txt", header=T)
fut=fut_cli[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
future_all=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,fut[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
genOffsetAll<-sqrt((future_all[,3]-all_tgrid[,3])^2+(future_all[,4]-all_tgrid[,4])^2+(future_all[,5]-all_tgrid[,5])^2+(future_all[,6]-all_tgrid[,6])^2+(future_all[,7]-all_tgrid[,7])^2+(future_all[,8]-all_tgrid[,8])^2+(future_all[,9]-all_tgrid[,9])^2+(future_all[,10]-all_tgrid[,10])^2+(future_all[,11]-all_tgrid[,11])^2+(future_all[,12]-all_tgrid[,12])^2+(future_all[,13]-all_tgrid[,13])^2+(future_all[,14]-all_tgrid[,14])^2+(future_all[,15]-all_tgrid[,15])^2+(future_all[,16]-all_tgrid[,16])^2+(future_all[,17]-all_tgrid[,17])^2+(future_all[,18]-all_tgrid[,18])^2+(future_all[,19]-all_tgrid[,19])^2+(future_all[,20]-all_tgrid[,20])^2+(future_all[,21]-all_tgrid[,21])^2)
Offset=cbind(future_all[,c("lon","lat")],genOffsetAll)
colnames(Offset)[3]<-"offset"
write.csv(Offset, "offset/data3_3436_2100_26.csv", quote=F, row.names=T)
#2100-45
fut_cli=fread("/usr_storage/syp/gf/syp-gf/cand3055/future/future60000/2100/future-2100-45.txt", header=T)
fut=fut_cli[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
future_all=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,fut[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
genOffsetAll<-sqrt((future_all[,3]-all_tgrid[,3])^2+(future_all[,4]-all_tgrid[,4])^2+(future_all[,5]-all_tgrid[,5])^2+(future_all[,6]-all_tgrid[,6])^2+(future_all[,7]-all_tgrid[,7])^2+(future_all[,8]-all_tgrid[,8])^2+(future_all[,9]-all_tgrid[,9])^2+(future_all[,10]-all_tgrid[,10])^2+(future_all[,11]-all_tgrid[,11])^2+(future_all[,12]-all_tgrid[,12])^2+(future_all[,13]-all_tgrid[,13])^2+(future_all[,14]-all_tgrid[,14])^2+(future_all[,15]-all_tgrid[,15])^2+(future_all[,16]-all_tgrid[,16])^2+(future_all[,17]-all_tgrid[,17])^2+(future_all[,18]-all_tgrid[,18])^2+(future_all[,19]-all_tgrid[,19])^2+(future_all[,20]-all_tgrid[,20])^2+(future_all[,21]-all_tgrid[,21])^2)
Offset=cbind(future_all[,c("lon","lat")],genOffsetAll)
colnames(Offset)[3]<-"offset"
write.csv(Offset, "offset/data3_3436_2100_45.csv", quote=F, row.names=T)
#2100-70
fut_cli=fread("/usr_storage/syp/gf/syp-gf/cand3055/future/future60000/2100/future-2100-70.txt", header=T)
fut=fut_cli[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
future_all=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,fut[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
genOffsetAll<-sqrt((future_all[,3]-all_tgrid[,3])^2+(future_all[,4]-all_tgrid[,4])^2+(future_all[,5]-all_tgrid[,5])^2+(future_all[,6]-all_tgrid[,6])^2+(future_all[,7]-all_tgrid[,7])^2+(future_all[,8]-all_tgrid[,8])^2+(future_all[,9]-all_tgrid[,9])^2+(future_all[,10]-all_tgrid[,10])^2+(future_all[,11]-all_tgrid[,11])^2+(future_all[,12]-all_tgrid[,12])^2+(future_all[,13]-all_tgrid[,13])^2+(future_all[,14]-all_tgrid[,14])^2+(future_all[,15]-all_tgrid[,15])^2+(future_all[,16]-all_tgrid[,16])^2+(future_all[,17]-all_tgrid[,17])^2+(future_all[,18]-all_tgrid[,18])^2+(future_all[,19]-all_tgrid[,19])^2+(future_all[,20]-all_tgrid[,20])^2+(future_all[,21]-all_tgrid[,21])^2)
Offset=cbind(future_all[,c("lon","lat")],genOffsetAll)
colnames(Offset)[3]<-"offset"
write.csv(Offset, "offset/data3_3436_2100_70.csv", quote=F, row.names=T)
#2100-85
fut_cli=fread("/usr_storage/syp/gf/syp-gf/cand3055/future/future60000/2100/future-2100-85.txt", header=T)
fut=fut_cli[,c("lon", "lat","bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio8","bio9","bio10","bio11","bio12","bio13","bio14","bio15","bio16","bio17","bio18","bio19")]
future_all=cbind(greengrid[,c("lon","lat")], predict.gradientForest(all_gfmod,fut[,c("bio2","bio7","bio4","bio6","bio9","bio11","bio12","bio1","bio8","bio10","bio15","bio16","bio18","bio13","bio17","bio19","bio3","bio14","bio5")]))
genOffsetAll<-sqrt((future_all[,3]-all_tgrid[,3])^2+(future_all[,4]-all_tgrid[,4])^2+(future_all[,5]-all_tgrid[,5])^2+(future_all[,6]-all_tgrid[,6])^2+(future_all[,7]-all_tgrid[,7])^2+(future_all[,8]-all_tgrid[,8])^2+(future_all[,9]-all_tgrid[,9])^2+(future_all[,10]-all_tgrid[,10])^2+(future_all[,11]-all_tgrid[,11])^2+(future_all[,12]-all_tgrid[,12])^2+(future_all[,13]-all_tgrid[,13])^2+(future_all[,14]-all_tgrid[,14])^2+(future_all[,15]-all_tgrid[,15])^2+(future_all[,16]-all_tgrid[,16])^2+(future_all[,17]-all_tgrid[,17])^2+(future_all[,18]-all_tgrid[,18])^2+(future_all[,19]-all_tgrid[,19])^2+(future_all[,20]-all_tgrid[,20])^2+(future_all[,21]-all_tgrid[,21])^2)
Offset=cbind(future_all[,c("lon","lat")],genOffsetAll)
colnames(Offset)[3]<-"offset"
write.csv(Offset, "offset/data3_3436_2100_85.csv", quote=F, row.names=T)


