#### LD-pruned
vcftools --gzvcf pk_chr.vcf.gz --plink --out pk
plink --file pk --maf 0.05 --geno 0.1 --indep-pairwise 50 10 0.2 --allow-extra-chr --allow-no-sex --make-bed --out pk
sed -i -e '/Contig/d' pk.prune.in
plink --file pk --extract pk.prune.in --recode --allow-extra-chr --allow-no-sex --make-bed --out pk_ldpruned

#### use Admixture to perform structure analyses 
#!/bin/bash
   set -e
 file="/w/00/g/g00/sangyupeng/xiangyang/final_vcf/vcf/structure_230/pk230_ldpruned.bed"
   outdir="/w/00/g/g00/sangyupeng/xiangyang/final_vcf/vcf/structure_230/K"
   AD="/data/apps/admixture/1.3.0/"
   for K in 1 2 3 4 5 6 7 8
   do
          echo "cd $outdir;$AD/admixture --cv $file $K|tee log${K}.out" >> /w/00/u/user201/pk_structure.sh
   done

#### Use Rscript to  plot

library(ggplot2)
library(reshape2)
library(RColorBrewer)
library(dplyr)
library(gridExtra)
setwd("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure")
#cbPalette <- c('#458B00','#D2691E','#8B4513','#76EEC6','#838B8B','#EED5B7','#6495ED','#000000','#8A2BE2','#EEAD0E','#A52A2A')
cbPalette <- c('#7FFFD4','#4D97DD','#4BA57D','#FFBC7B','#FFFF40','#CCCC4C','#FFFF40')
myorder <- c("ZHY-03-1","ZHY-03-10","ZHY-03-12","ZHY-03-17","ZHY-03-2","ZHY-03-3","ZHY-03-4","ZHY-03-6","ZHY-03-7","ZHY-03-9","ZHY-09-1","ZHY-09-11","ZHY-09-15","ZHY-09-16","ZHY-09-17","ZHY-09-18","ZHY-09-2","ZHY-09-6","ZHY-09-8","ZHY-10-1","ZHY-10-11","ZHY-10-13","ZHY-10-14","ZHY-10-15","ZHY-10-16","ZHY-10-3","ZHY-10-4","ZHY-10-6","ZHY-10-9","LiuJQ-MZL-2013-249-1","LiuJQ-MZL-2013-249-10","LiuJQ-MZL-2013-249-3","LiuJQ-MZL-2013-249-4","LiuJQ-MZL-2013-249-5","LiuJQ-MZL-2013-249-6","LiuJQ-MZL-2013-249-7","LiuJQ-MZL-2013-249-8","LiuJQ-MZL-2013-249-9","LiuJQ-MZL-2013-262-1","LiuJQ-MZL-2013-262-10","LiuJQ-MZL-2013-262-11","LiuJQ-MZL-2013-262-3","LiuJQ-MZL-2013-262-5","LiuJQ-MZL-2013-262-6","LiuJQ-MZL-2013-262-7","LiuJQ-MZL-2013-262-8","LiuJQ-MZL-2013-262-9","LiuJQ-MZL-2013-283-1","LiuJQ-MZL-2013-283-10","LiuJQ-MZL-2013-283-12","LiuJQ-MZL-2013-283-15","LiuJQ-MZL-2013-283-3","LiuJQ-MZL-2013-283-4","LiuJQ-MZL-2013-283-5","LiuJQ-MZL-2013-283-6","LiuJQ-MZL-2013-283-8","LiuJQ-MZL-2013-283-9","LiuJQ-MZL-2013-297-1","LiuJQ-MZL-2013-297-10","LiuJQ-MZL-2013-297-2","LiuJQ-MZL-2013-297-3","LiuJQ-MZL-2013-297-4","LiuJQ-MZL-2013-297-5","LiuJQ-MZL-2013-297-6","LiuJQ-MZL-2013-297-7","LiuJQ-MZL-2013-297-8","LiuJQ-MZL-2013-297-9","ZHY-14-1","ZHY-14-12","ZHY-14-13","ZHY-14-2","ZHY-14-3","ZHY-14-4","ZHY-14-5","ZHY-14-6","ZHY-14-7","ZHY-14-9","ZHY-16-1","ZHY-16-12","ZHY-16-13","ZHY-16-14","ZHY-16-15","ZHY-16-2","ZHY-16-3","ZHY-16-4","ZHY-16-6","ZHY-16-8","ZHY-17-1","ZHY-17-12","ZHY-17-13","ZHY-17-14","ZHY-17-15","ZHY-17-5","ZHY-17-6","ZHY-17-8","ZHY-17-9","ZHY-18-10","ZHY-18-13","ZHY-18-2","ZHY-18-3","ZHY-18-4","ZHY-18-5","ZHY-18-7","ZHY-18-8","ZHY-18-9","ZHY-19-10","ZHY-19-11","ZHY-19-12","ZHY-19-13","ZHY-19-14","ZHY-19-15","ZHY-19-5","ZHY-19-6","ZHY-19-8","ZHY-19-9","ZHY-21-1","ZHY-21-11","ZHY-21-12","ZHY-21-14","ZHY-21-2","ZHY-21-3","ZHY-21-4","ZHY-21-5","ZHY-21-7","ZHY-21-8","ZHY-22-1","ZHY-22-10","ZHY-22-11","ZHY-22-12","ZHY-22-3","ZHY-22-6","ZHY-22-7","ZHY-22-8","ZHY-22-9","LiuJQ-MZL-2013-323-0","LiuJQ-MZL-2013-323-10","LiuJQ-MZL-2013-323-11","LiuJQ-MZL-2013-323-12","LiuJQ-MZL-2013-323-13","LiuJQ-MZL-2013-323-4","LiuJQ-MZL-2013-323-5","LiuJQ-MZL-2013-323-6","LiuJQ-MZL-2013-323-7","LiuJQ-MZL-2013-323-9","ZHY-25-10","ZHY-25-11","ZHY-25-12","ZHY-25-13","ZHY-25-14","ZHY-25-3","ZHY-25-4","ZHY-25-7","ZHY-25-8","ZHY-25-9","ZHY-26-1","ZHY-26-10","ZHY-26-11","ZHY-26-12","ZHY-26-13","ZHY-26-15","ZHY-26-2","ZHY-26-3","ZHY-26-4","ZHY-26-8","ZHY-31-1","ZHY-31-10","ZHY-31-11","ZHY-31-12","ZHY-31-2","ZHY-31-3","ZHY-31-4","ZHY-31-7","ZHY-31-8","ZHY-33-1","ZHY-33-10","ZHY-33-11","ZHY-33-12","ZHY-33-3","ZHY-33-6","ZHY-33-7","ZHY-33-8","ZHY-33-9","ZHY-34-1","ZHY-34-11","ZHY-34-12","ZHY-34-13","ZHY-34-14","ZHY-34-2","ZHY-34-4","ZHY-34-5","ZHY-34-7","ZHY-34-9","ZHY-35-1","ZHY-35-10","ZHY-35-2","ZHY-35-3","ZHY-35-4","ZHY-35-5","ZHY-35-6","ZHY-35-7","ZHY-35-8","ZHY-35-9","ZHY-37-10","ZHY-37-11","ZHY-37-12","ZHY-37-15","ZHY-37-2","ZHY-37-3","ZHY-37-4","ZHY-37-6","ZHY-37-8","ZHY-37-9","ZHY-41-1","ZHY-41-10","ZHY-41-11","ZHY-41-12","ZHY-41-13","ZHY-41-2","ZHY-41-4","ZHY-41-6","ZHY-41-7","ZHY-41-9","ZHY-44-1","ZHY-44-10","ZHY-44-2","ZHY-44-3","ZHY-44-4","ZHY-44-5","ZHY-44-6","ZHY-44-9")
myorder <- factor(1:length(myorder),labels = myorder)
admix_sample=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/sample.txt",header=F)
Message=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/Q/message.txt",header=T)
Q2=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/Q/pk230_ldpruned.2.Q",header=F)
Q3=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/Q/pk230_ldpruned.3.Q",header=F)
Q4=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/Q/pk230_ldpruned.4.Q",header=F)
Q5=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/Q/pk230_ldpruned.5.Q",header=F)
Q6=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/Q/pk230_ldpruned.6.Q",header=F)
Q7=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/Q/pk230_ldpruned.7.Q",header=F)
Q8=read.table("F:/360MoveData/Users/Desktop/4structure_pca/pk230structure/Q/pk230_ldpruned.8.Q",header=F)

names(admix_sample)="ind_ID"
new_Q2=cbind(admix_sample,Q2)
new_Q3=cbind(admix_sample,Q3)
new_Q4=cbind(admix_sample,Q4)
new_Q5=cbind(admix_sample,Q5)
new_Q6=cbind(admix_sample,Q6)
new_Q7=cbind(admix_sample,Q7)
new_Q8=cbind(admix_sample,Q8)

Q2_data=merge(Message,new_Q2,by.x="ind_ID")
Q3_data=merge(Message,new_Q3,by.x="ind_ID")
Q4_data=merge(Message,new_Q4,by.x="ind_ID")
Q5_data=merge(Message,new_Q5,by.x="ind_ID")
Q6_data=merge(Message,new_Q6,by.x="ind_ID")
Q7_data=merge(Message,new_Q7,by.x="ind_ID")
Q8_data=merge(Message,new_Q8,by.x="ind_ID")

Q2_data$ind_ID <- factor(Q2_data$ind_ID,levels = levels(myorder))
Q2_new_t=melt(Q2_data,id=c("species_ID","ind_ID"))
Q3_data$ind_ID <- factor(Q3_data$ind_ID,levels = levels(myorder))
Q3_new_t=melt(Q3_data,id=c("species_ID","ind_ID"))
Q4_data$ind_ID <- factor(Q4_data$ind_ID,levels = levels(myorder))
Q4_new_t=melt(Q4_data,id=c("species_ID","ind_ID"))
Q5_data$ind_ID <- factor(Q5_data$ind_ID,levels = levels(myorder))
Q5_new_t=melt(Q5_data,id=c("species_ID","ind_ID"))
Q6_data$ind_ID <- factor(Q6_data$ind_ID,levels = levels(myorder))
Q6_new_t=melt(Q6_data,id=c("species_ID","ind_ID"))
Q7_data$ind_ID <- factor(Q7_data$ind_ID,levels = levels(myorder))
Q7_new_t=melt(Q7_data,id=c("species_ID","ind_ID"))
Q8_data$ind_ID <- factor(Q8_data$ind_ID,levels = levels(myorder))
Q8_new_t=melt(Q8_data,id=c("species_ID","ind_ID"))

write.table(Q2_data,"Q2.summary.txt",quote=F,sep="\t",row.names=F)
write.table(Q3_data,"Q3.summary.txt",quote=F,sep="\t",row.names=F)
write.table(Q4_data,"Q4.summary.txt",quote=F,sep="\t",row.names=F)
write.table(Q5_data,"Q5.summary.txt",quote=F,sep="\t",row.names=F)
write.table(Q6_data,"Q6.summary.txt",quote=F,sep="\t",row.names=F)
write.table(Q7_data,"Q7.summary.txt",quote=F,sep="\t",row.names=F)
write.table(Q8_data,"Q8.summary.txt",quote=F,sep="\t",row.names=F)

#Q2
p1=ggplot(Q2_new_t, aes(x=factor(ind_ID),y=value,fill=factor(variable))) + 
  geom_bar(stat='identity',width=1) +
  ylab(label ="K=2")+
  theme_bw() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=30),
        axis.text.y=element_text(size=30),
        legend.position='none',axis.title.y = element_text(size = 50),
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  scale_y_continuous(minor_breaks=seq(0,1,0.1),
                     expand = c(0,0),
                     breaks=seq(0,1,0.25))+
  scale_x_discrete(breaks=NULL)+
  scale_fill_manual(values=c(cbPalette[1],cbPalette[2]))
ggsave(p1,filename='admix.out.2.Q.pdf',width=15,height=5,dpi=600)

#Q3
p2=ggplot(Q3_new_t, aes(x=factor(ind_ID),y=value,fill=factor(variable))) + 
  geom_bar(stat='identity',width=1) +
  ylab(label ="K=3")+
  theme_bw() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=30),
        axis.text.y=element_text(size=30),
        legend.position='none',axis.title.y = element_text(size = 50),
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  scale_y_continuous(minor_breaks=seq(0,1,0.1),
                     expand = c(0,0),
                     breaks=seq(0,1,0.25))+
  scale_x_discrete(breaks=NULL)+
  scale_fill_manual(values=c(cbPalette[2],cbPalette[4],cbPalette[1]))
ggsave(p2,filename='admix.out.3.Q.pdf',width=15,height=5,dpi=600)

#Q4
p3=ggplot(Q4_new_t, aes(x=factor(ind_ID),y=value,fill=factor(variable))) + 
  geom_bar(stat='identity',width=1) +
  ylab(label ="K=4")+
  theme_bw() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=30),
        axis.text.y=element_text(size=30),
        legend.position='none',axis.title.y = element_text(size = 50),
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  scale_y_continuous(minor_breaks=seq(0,1,0.1),
                     expand = c(0,0),
                     breaks=seq(0,1,0.25))+
  scale_x_discrete(breaks=NULL)+
  scale_fill_manual(values=c(cbPalette[2],cbPalette[4],cbPalette[1],cbPalette[3]))
ggsave(p3,filename='admix.out.4.Q.pdf',width=15,height=5,dpi=600)
p4=ggplot(Q5_new_t,aes(x=factor(ind_ID),y=value,fill=factor(variable))) + 
  geom_bar(stat='identity',width=1) +
  ylab(label ="K=5")+
  theme_bw() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=30),
        axis.text.y=element_text(size=30),
        legend.position='none',axis.title.y = element_text(size = 50),
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  scale_y_continuous(minor_breaks=seq(0,1,0.1),
                     expand = c(0,0),
                     breaks=seq(0,1,0.25))+
  scale_x_discrete(breaks=NULL)+
  scale_fill_manual(values=c(cbPalette[4],cbPalette[2],cbPalette[3],cbPalette[5],cbPalette[1]))

p5=ggplot(Q6_new_t,aes(x=factor(ind_ID),y=value,fill=factor(variable))) + 
  geom_bar(stat='identity',width=1) +
  ylab(label ="K=6")+
  theme_bw() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=30),
        axis.text.y=element_text(size=30),
        legend.position='none',axis.title.y = element_text(size = 50),
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  scale_y_continuous(minor_breaks=seq(0,1,0.1),
                     expand = c(0,0),
                     breaks=seq(0,1,0.25))+
  scale_x_discrete(breaks=NULL)+
  scale_fill_manual(values=c(cbPalette[7],cbPalette[5],cbPalette[3],cbPalette[1],cbPalette[2],cbPalette[4]))
ggsave(p5,filename='admix.out.6.Q.pdf',width=15,height=5,dpi=600)

p6=ggplot(Q7_new_t,aes(x=factor(ind_ID),y=value,fill=factor(variable))) + 
  geom_bar(stat='identity',width=1) +
  ylab(label ="K=7")+
  theme_bw() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5,size=30),
        axis.text.y=element_text(size=30),
        legend.position='none',axis.title.y = element_text(size = 50),
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  scale_y_continuous(minor_breaks=seq(0,1,0.1),
                     expand = c(0,0),
                     breaks=seq(0,1,0.25))+
  scale_fill_manual(values=c(cbPalette[4],cbPalette[2],cbPalette[7],cbPalette[1],cbPalette[5],cbPalette[6],cbPalette[3]))
ggsave(p6,filename='admix.out.7.Q.pdf',width=15,height=5,dpi=600)

all=grid.arrange(p1,p2,p3,p4,p5,p6,heights=c(1.5/10,1.5/10,1.5/10,1.5/10,1.5/10,2.5/10),ncol=1)
ggsave(all,filename='PK230.pdf',width=90,height=45,dpi=600,limitsize = FALSE)