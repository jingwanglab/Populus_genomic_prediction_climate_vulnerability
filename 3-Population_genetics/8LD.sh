########  use PopLDdecay to calculate the squared correlation coefficient (r2) between pairwise SNPs with MAF >0.1 in a 100-kb window.

/w/00/g/g00/sangyupeng/xiangyang/LDdecay/pk_paper;/w/00/u/user201/software/PopLDdecay/bin/PopLDdecay -InVCF /w/00/g/g00/sangyupeng/xiangyang/final_vcf/vcf/pk_230.recode.vcf.gz -MAF 0.1 -SubPop /w/00/g/g00/sangyupeng/xiangyang/LDdecay/pop/pk_north.list -OutType 5 -OutStat pk_north_maf0.1
cd /w/00/g/g00/sangyupeng/xiangyang/LDdecay/pk_paper;/w/00/u/user201/software/PopLDdecay/bin/PopLDdecay -InVCF /w/00/g/g00/sangyupeng/xiangyang/final_vcf/vcf/pk_230.recode.vcf.gz -MAF 0.1 -SubPop /w/00/g/g00/sangyupeng/xiangyang/LDdecay/pop/pk_south.list -OutType 5 -OutStat pk_south_maf0.1

######## ploting with R 

#! /usr_storage/syp/.conda/envs/R/bin/Rscript --no-save --no-restore
.libPaths("/usr_storage/syp/.conda/envs/R/lib/R/library")
setwd("/usr_storage/syp/pk_paper/pk_ld")
rm(list=ls())
library(ggplot2)
library(cowplot)
library(data.table)
library(tidyr)
South_quantile=fread("pk_south_maf0.1.stat",skip=1,header=F)
South_line=read.table("pk_paper.South",header = F)

syp_LD <- function(line_file,quantile_file){
  line_file=line_file[,c(1,2)]
  colnames(line_file)=c("Dist","r2")
  colnames(quantile_file)=c("Dist","r2","count")
  quantile_file=subset(quantile_file,Dist<=100000)
  line_file=subset(line_file,Dist<=100000)
  syp_output <- data.frame(Dist=0,r2=0,quantile_05=0,quantile_95=0)
  syp_output=syp_output[-1,]
  i=1
  temp_quantile=subset(quantile_file, Dist<=line_file$Dist[i])
  syp_output[i,1]=line_file[i,1]
  syp_output[i,2]=line_file[i,2]
  value_temp=quantile(rep(temp_quantile$r2, temp_quantile$count),probs = c(0.05,0.95))
  syp_output[i,3]=value_temp[1]
  syp_output[i,4]=value_temp[2]
  for (i in 2:length(line_file$Dist)){
    start=line_file$Dist[i-1]
    end=line_file$Dist[i]
    temp_quantile=subset(quantile_file, Dist<=end & Dist>start)
    syp_output[i,1]=line_file[i,1]
    syp_output[i,2]=line_file[i,2]
    value_temp=quantile(rep(temp_quantile$r2, temp_quantile$count),probs = c(0.05,0.95))
    syp_output[i,3]=value_temp[1]
    syp_output[i,4]=value_temp[2]
  }
  return(syp_output)
}
plot_file=syp_LD(South_line,South_quantile)
write.table(plot_file,"plot_file_South.txt",quote=F,row.names=F)
### plot:
South_plot=ggplot()+
  geom_ribbon(data=plot_file,aes(ymin=quantile_05,ymax=quantile_95,x=Dist/1000),fill="#ff3333",alpha=0.2)+
  geom_line(data=plot_file,aes(x=Dist/1000,y=r2),col="#ff3333",size=2)+
  xlab("Distance(kb)")+ylab(expression(r^2))+
  theme_bw()+
  theme(
    text=element_text(family="serif"),
    axis.text.x=element_text(hjust=1,size=13,family="serif"),
    axis.text.y=element_text(size=13,family="serif"), 
    plot.title = element_text(
      size = 12L,
      hjust = 0.5
    ),
    axis.ticks=element_line(
      colour="black",
      size=.001,
      linetype=1,
      lineend=.1),
    axis.title.y = element_text(size = 14,family="serif"),
    plot.subtitle = element_text(hjust = 0,size=12,family="serif"),
    legend.position = "none",
    axis.title.x = element_text(size = 16,family="serif"),
    panel.background=element_rect(fill="white"),
    plot.background = element_rect(fill = "white"),
    panel.grid.major =element_blank(), panel.grid.minor = element_blank(),
    plot.margin=unit(c(1,1,1,1),"mm"),
    panel.border=element_blank(),
    axis.line = element_line(color ="black",size=0.6))

#### North
North_quantile=fread("pk_north_maf0.1.stat",skip=1,header=F)
North_line=read.table("pk_paper.North",header = F)
plot_file2=syp_LD(North_line,North_quantile)
write.table(plot_file2,"plot_file_North.txt",quote=F,row.names=F)
#### plot:
North_plot=ggplot()+
  geom_ribbon(data=plot_file2,aes(ymin=quantile_05,ymax=quantile_95,x=Dist/1000),fill="#0a6690",alpha=0.2)+
  geom_line(data=plot_file,aes(x=Dist/1000,y=r2),col="#0a6690",size=2)+
  xlab("Distance(kb)")+ylab(expression(r^2))+
  theme_bw()+
  theme(
    text=element_text(family="serif"),
    axis.text.x=element_text(hjust=1,size=13,family="serif"),
    axis.text.y=element_text(size=13,family="serif"), 
    plot.title = element_text(
      size = 12L,
      hjust = 0.5
    ),
    axis.ticks=element_line(
      colour="black",
      size=.001,
      linetype=1,
      lineend=.1),
    axis.title.y = element_text(size = 14,family="serif"),
    plot.subtitle = element_text(hjust = 0,size=12,family="serif"),
    legend.position = "none",
    axis.title.x = element_text(size = 16,family="serif"),
    panel.background=element_rect(fill="white"),
    plot.background = element_rect(fill = "white"),
    panel.grid.major =element_blank(), panel.grid.minor = element_blank(),
    plot.margin=unit(c(1,1,1,1),"mm"),
    panel.border=element_blank(),
    axis.line = element_line(color ="black",size=0.6))
### merge
P=plot_grid(North_plot,South_plot,ncol=2,align ="v",rel_heights = c(1, 1),rel_widths = c(1, 1))
ggsave(P,filename="pkSN_quantile.pdf",width=12,height=5.5,dpi=600)


